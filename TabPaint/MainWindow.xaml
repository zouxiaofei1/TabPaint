<Window x:Class="TabPaint.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:TabPaint" 
        xmlns:controls="clr-namespace:TabPaint.Controls"
        xmlns:System="clr-namespace:System;assembly=mscorlib"
        Title="TabPaint"
        Height="900" Width="1250"
        MinHeight="400" MinWidth="600"
        Top="100" Left="100"
        SizeToContent="Manual"
        AllowsTransparency="True"
        WindowStyle="None"
        SizeChanged="Window_SizeChanged"
        Background="#01000000">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- 引入全局样式 -->
                <ResourceDictionary Source="pack://application:,,,/Resources/Styles.xaml"/>
                <!-- 引入刚刚抽离的局部样式 -->
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>

    <Grid Background="Transparent" DragOver="OnGlobalDragOver"
          Drop="OnGlobalDrop"
          DragLeave="OnGlobalDragLeave">
        <DockPanel LastChildFill="True">

            <!-- #region 1. 自定义标题栏 (TitleBar) -->
            <controls:TitleBarControl x:Name="AppTitleBar" 
                          DockPanel.Dock="Top" 
                          MinimizeClick="Minimize_Click"
                          MaximizeRestoreClick="MaximizeRestore_Click"
                          CloseClick="Close_Click"/>
            <!-- #endregion -->
            
            <!-- #region 2. 菜单栏 (MenuBar) -->
            <controls:MenuBarControl x:Name="MainMenu" DockPanel.Dock="Top"
                                     
                                     NewClick="OnNewClick"
                                     OpenClick="OnOpenClick"
                                     SaveClick="OnSaveClick"
                                     SaveAsClick="OnSaveAsClick"
                                     ExitClick="OnExitClick"
                                     
                                     CopyClick="OnCopyClick"
                                     CutClick="OnCutClick"
                                     PasteClick="OnPasteClick"
                                     ResizeCanvasClick="OnResizeCanvasClick"
                                     
                                     BCEClick="OnBrightnessContrastExposureClick"
                                     TTSClick="OnColorTempTintSaturationClick"
                                     BlackWhiteClick="OnConvertToBlackAndWhiteClick"
                                     
                                     UndoClick="OnUndoClick"
                                     RedoClick="OnRedoClick"
                                     SettingsClick="OnSettingsClick"/>
     
            <!-- #endregion -->

            <!-- #region 3. 工具栏 (ToolBar) -->
            <controls:ToolBarControl x:Name="MainToolBar"
                                     DockPanel.Dock="Top" 
                                     
                                     PenClick="OnPenClick"
                                     PickColorClick="OnPickColorClick"
                                     EraserClick="OnEraserClick"
                                     SelectClick="OnSelectClick"
                                     FillClick="OnFillClick"
                                     TextClick="OnTextClick"
                                     
                                     BrushStyleClick="OnBrushStyleClick"
                                     ShapeStyleClick="OnShapeStyleClick"
                                     
                                     CropClick="CropMenuItem_Click"
                                     RotateLeftClick="OnRotateLeftClick"
                                     RotateRightClick="OnRotateRightClick"
                                     Rotate180Click="OnRotate180Click"
                                     FlipVerticalClick="OnFlipVerticalClick"
                                     FlipHorizontalClick="OnFlipHorizontalClick"
                                     
                                     CustomColorClick="OnCustomColorClick"
                                     ColorOneClick="OnColorOneClick"
                                     ColorTwoClick="OnColorTwoClick"
                                     ColorButtonClick="OnColorButtonClick"/>
            <!-- #endregion -->

            <!-- #region 4. 图片列表栏 (ImageBar) -->
            <controls:ImageBarControl x:Name="MainImageBar"
                DockPanel.Dock="Top"
                  SaveAllClick="OnSaveAllClick"
                  ClearUneditedClick="OnClearUneditedClick"
                  DiscardAllClick="OnDiscardAllClick"
                  PrependTabClick="OnPrependTabClick"
                  NewTabClick="OnNewTabClick"
                  
                  FileTabClick="OnFileTabClick"
                  FileTabCloseClick="OnFileTabCloseClick"
                  
                  FileTabPreviewMouseDown="OnFileTabPreviewMouseDown"
                  FileTabPreviewMouseMove="OnFileTabPreviewMouseMove"
                  FileTabDrop="OnFileTabDrop"
                  FileTabReorderDragOver="OnFileTabReorderDragOver"
                  
                  FileTabsWheelScroll="OnFileTabsWheelScroll"
                  FileTabsScrollChanged="OnFileTabsScrollChanged"
                  PreviewSliderValueChanged="PreviewSlider_ValueChanged"
                  SliderPreviewMouseWheel="Slider_PreviewMouseWheel"
                  
                  TabCopyClick="OnTabCopyClick"
                  TabCutClick="OnTabCutClick"
                  TabPasteClick="OnTabPasteClick"
                  TabOpenFolderClick="OnTabOpenFolderClick"
                  TabDeleteClick="OnTabDeleteClick"
                  TabFileDeleteClick="OnTabFileDeleteClick"/>
            <!-- #endregion -->

            <!-- #region 5. 底部状态栏 (StatusBar) -->
            <controls:StatusBarControl x:Name="MyStatusBar" DockPanel.Dock="Bottom"
                                       ClipboardMonitorClick="ClipboardMonitorToggle_Click"
                                       FitToWindowClick="FitToWindow_Click"
                                       ZoomOutClick="ZoomOut_Click"
                                       ZoomInClick="ZoomIn_Click"
                                       ZoomSelectionChanged="ZoomMenu_SelectionChanged"/>
            <!-- #endregion -->

            <!-- #region 6. 主画布区域 (Canvas) -->
            <ScrollViewer Name="ScrollContainer" FocusVisualStyle="{x:Null}" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" PreviewMouseWheel="OnMouseWheelZoom" Background="Transparent" PreviewMouseDown="OnScrollContainerMouseDown" PreviewMouseMove="OnScrollContainerMouseMove"  PreviewMouseUp="OnScrollContainerMouseUp" AllowDrop="True" >
                <ScrollViewer.ContextMenu>
                    <ContextMenu Style="{StaticResource Win11ContextMenuStyle}">
                        <MenuItem Header="复制" InputGestureText="Ctrl+C" Style="{StaticResource Win11MenuItemStyle}" Click="OnCopyClick"/>
                        <Separator Style="{StaticResource Win11MenuSeparatorStyle}"/>
                        <MenuItem Header="粘贴" InputGestureText="Ctrl+V" Style="{StaticResource Win11MenuItemStyle}" Click="OnPasteClick"/>
                        <MenuItem Header="固定缩放倍数" 
                      IsCheckable="True" 
                      IsChecked="{Binding IsFixedZoom, Mode=TwoWay}" 
                      Style="{StaticResource Win11MenuItemStyle}"/>
                    </ContextMenu>
                </ScrollViewer.ContextMenu>

                <Grid Name="CanvasWrapper" HorizontalAlignment="Center" VerticalAlignment="Center" SnapsToDevicePixels="True" UseLayoutRounding="True" Background="{StaticResource CheckerboardBrush}">
                    <Grid.LayoutTransform>
                        <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1" />
                    </Grid.LayoutTransform>

                    <!-- 1. 基础图片 -->
                    <Image Name="BackgroundImage" Stretch="None" HorizontalAlignment="Left" VerticalAlignment="Top" SnapsToDevicePixels="True" RenderOptions.BitmapScalingMode="NearestNeighbor" />
                    <!-- 2. 调整大小层 -->
                    <Canvas Name="CanvasResizeOverlay" Visibility="Visible" IsHitTestVisible="True" Background="Transparent"/>
                    <!-- 3. 选区预览层 -->
                    <Image Name="SelectionPreview" Stretch="Fill" HorizontalAlignment="Left" VerticalAlignment="Top" IsHitTestVisible="False" RenderOptions.BitmapScalingMode="NearestNeighbor" UseLayoutRounding="True" RenderOptions.EdgeMode="Aliased" Margin="0" SnapsToDevicePixels="True" Visibility="Collapsed"/>
                    <!-- 4. 选区UI层 -->
                    <Canvas Name="SelectionOverlayCanvas" Visibility="Collapsed" IsHitTestVisible="False" Background="Transparent" UseLayoutRounding="False" SnapsToDevicePixels="False"/>
                    <!-- 5. 编辑器层 -->
                    <Canvas Name="EditorOverlayCanvas" Background="Transparent" IsHitTestVisible="False" Visibility="Visible"/>
                </Grid>
            </ScrollViewer>
            <!-- #endregion -->

        </DockPanel>

        <!-- #region 7. 悬浮面板 (Floating UI) -->

        <!-- 文本编辑条 -->
        <Border x:Name="TextEditBar" Visibility="Collapsed" MouseDown="TextEditBar_MouseDown" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,80,0,0" Background="#FAFAFA" BorderBrush="#E5E5E5" BorderThickness="1" CornerRadius="8" Padding="6">
            <Border.Effect>
                <DropShadowEffect BlurRadius="12" ShadowDepth="4" Direction="270" Color="#20000000" Opacity="0.4"/>
            </Border.Effect>
            <StackPanel Orientation="Horizontal">
                <ComboBox x:Name="FontFamilyBox" Style="{StaticResource FluentComboBoxStyle}" Width="180" ItemsSource="{x:Static Fonts.SystemFontFamilies}" DisplayMemberPath="Source" SelectedValuePath="Source" KeyDown="Control_KeyDown" IsEditable="True" StaysOpenOnEdit="True" TextSearch.TextPath="Source" SelectionChanged="FontSettingChanged" TextBoxBase.TextChanged="FontSettingChanged" SelectedIndex="0">
                    <ComboBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel />
                        </ItemsPanelTemplate>
                    </ComboBox.ItemsPanel>
                </ComboBox>
                <ComboBox x:Name="FontSizeBox" Style="{StaticResource FluentComboBoxStyle}" Width="80" SelectionChanged="FontSettingChanged" TextBoxBase.TextChanged="FontSettingChanged" KeyDown="Control_KeyDown" IsEditable="True" Text="12">
                    <System:Double>8</System:Double>
                    <System:Double>9</System:Double>
                    <System:Double>10</System:Double>
                    <System:Double>11</System:Double>
                    <System:Double>12</System:Double>
                    <System:Double>14</System:Double>
                    <System:Double>16</System:Double>
                    <System:Double>18</System:Double>
                    <System:Double>24</System:Double>
                    <System:Double>36</System:Double>
                    <System:Double>48</System:Double>
                    <System:Double>72</System:Double>
                </ComboBox>
                <Rectangle Width="1" Height="20" Fill="#E0E0E0" Margin="4,0,8,0"/>
                <ToggleButton x:Name="BoldBtn" Style="{StaticResource FluentToggleButtonStyle}" ToolTip="加粗">
                    <TextBlock Text="B" FontWeight="Bold" FontFamily="Segoe UI" FontSize="16"/>
                </ToggleButton>
                <ToggleButton x:Name="ItalicBtn" Style="{StaticResource FluentToggleButtonStyle}" ToolTip="斜体">
                    <TextBlock Text="I" FontStyle="Italic" FontFamily="Times New Roman" FontSize="16"/>
                </ToggleButton>
                <ToggleButton x:Name="UnderlineBtn" Style="{StaticResource FluentToggleButtonStyle}" ToolTip="下划线">
                    <TextBlock Text="U" TextDecorations="Underline" FontFamily="Segoe UI" FontSize="16"/>
                </ToggleButton>
            </StackPanel>
        </Border>

        <!-- 粗细调节条 -->
        <Border x:Name="ThicknessPanel" Width="42" Height="240" CornerRadius="12" Background="#F3F3F3" BorderBrush="#D0D0D0" BorderThickness="1" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="15">
            <Border.Effect>
                <DropShadowEffect BlurRadius="15" Opacity="0.15" ShadowDepth="2"/>
            </Border.Effect>
            <Grid x:Name="SliderContainer">
                <Slider x:Name="ThicknessSlider" Style="{StaticResource Win11VerticalSliderStyle}" Orientation="Vertical" Minimum="1" Maximum="250" Value="{Binding PenThickness, Mode=TwoWay}" IsSnapToTickEnabled="True" TickFrequency="1" Thumb.DragStarted="ThicknessSlider_DragStarted" Thumb.DragCompleted="ThicknessSlider_DragCompleted" ValueChanged="ThicknessSlider_ValueChanged">
                    <Slider.ToolTip>
                        <ToolTip Background="Black" Foreground="White" BorderThickness="0" Padding="8,4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Value, ElementName=ThicknessSlider, StringFormat={}{0:F0}}"/>
                                <TextBlock Text=" 像素" Margin="2,0,0,0"/>
                            </StackPanel>
                        </ToolTip>
                    </Slider.ToolTip>
                </Slider>
            </Grid>
        </Border>

        <!-- 粗细提示 -->
        <Border x:Name="ThicknessTip" Background="#333" CornerRadius="4" Padding="6,2" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="30,0,0,0" Visibility="Collapsed">
            <TextBlock x:Name="ThicknessTipText" Foreground="White" FontSize="12" TextWrapping="NoWrap" TextAlignment="Center"/>
        </Border>

        <!-- 粗细预览圆 -->
        <Ellipse x:Name="ThicknessPreview" Fill="Transparent" Stroke="MediumPurple" StrokeThickness="2" Width="40" Height="40" Visibility="Collapsed" Opacity="0.6" StrokeDashArray="3 2" HorizontalAlignment="Center" VerticalAlignment="Center"/>

        <!-- 通知层 -->
        <Grid x:Name="NotificationLayer" VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,0,0,120" IsHitTestVisible="False">
            <Border x:Name="InfoToast" Background="#A0444444" CornerRadius="20" Padding="20,8" Opacity="0">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="0" Opacity="0.3"/>
                </Border.Effect>
                <TextBlock x:Name="InfoToastText" Text="提示信息" Foreground="White" FontSize="14" VerticalAlignment="Center"/>
            </Border>
        </Grid>
        <!-- #endregion -->
        
        <!-- #region 8. 拖拽遮罩层 (Drag Overlay) -->
        <Grid x:Name="DragOverlay" Visibility="Collapsed" IsHitTestVisible="False" Background="#77111111">

            <!-- 虚线边框背景 -->
            <Rectangle Stroke="White" StrokeThickness="3" RadiusX="20" RadiusY="20" Margin="40" StrokeDashArray="4 2"/>

            <!-- 文字和图标内容 -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <!-- 图标 -->
                <Path x:Name="DragOverlayIcon" Width="64" Height="64" Fill="White" Stretch="Uniform" Margin="0,0,0,20"
                      Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />

                <!-- 提示文字 -->
                <TextBlock x:Name="DragOverlayText" Text="拖放以打开" Foreground="White" FontSize="28" FontWeight="Light" TextAlignment="Center"/>

                <!-- 副标题 -->
                <TextBlock x:Name="DragOverlaySubText" Text="释放鼠标以确认" Foreground="#CCC" FontSize="16" Margin="0,10,0,0" TextAlignment="Center"/>
            </StackPanel>
        </Grid>
        <!-- #endregion -->
    </Grid>
</Window>