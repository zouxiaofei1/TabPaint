<UserControl x:Class="TabPaint.Controls.ToolBarControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:TabPaint.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="36" d:DesignWidth="1200">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Resources/Styles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Border Height="36" Background="Transparent" AllowDrop="True">
        <DockPanel LastChildFill="False" VerticalAlignment="Center" Margin="1,0">
            <!-- 基础工具 -->
			<Button Margin="6,0,2,0" Name="PenButton" x:FieldModifier="public" Click="OnPenClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image x:Name="PenIcon" x:FieldModifier="public" Source="{StaticResource Pencil_Image}" Width="16" Height="16"/>
			</Button>
			<Button Margin="2,0" Name="PickColorButton" x:FieldModifier="public" ToolTip="取颜色" Click="OnPickColorClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image x:Name="PickColorIcon" x:FieldModifier="public" Source="{StaticResource Pick_Colour_Image}" Width="16" Height="16"/>
			</Button>
			<Button Margin="2,0" Name="EraserButton" x:FieldModifier="public" ToolTip="橡皮擦" Click="OnEraserClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image x:Name="EraserIcon" x:FieldModifier="public" Source="{StaticResource Eraser_Image}" Width="16" Height="16"/>
			</Button>
			<Button Margin="2,0" Name="SelectButton" x:FieldModifier="public" ToolTip="选择区域" Click="OnSelectClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image x:Name="SelectIcon" x:FieldModifier="public" Source="{StaticResource Select_Image}" Width="16" Height="16"/>
			</Button>
			<Button Margin="2,0" Name="FillButton" x:FieldModifier="public" ToolTip="填充" Click="OnFillClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image x:Name="FillIcon" x:FieldModifier="public" Source="{StaticResource Fill_Bucket_Image}" Width="16" Height="16"/>
			</Button>
			<Button Margin="2,0" Name="TextButton" x:FieldModifier="public" ToolTip="文字" Click="OnTextClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image x:Name="TextIcon" x:FieldModifier="public" Source="{StaticResource Text_Image}" Width="16" Height="16"/>
			</Button>

            <!-- 画刷菜单 (Popup 逻辑保留在 XAML 内部) -->
            <Grid>
				<ToggleButton x:Name="BrushToggle" x:FieldModifier="public" Style="{StaticResource DropDownButtonStyle}">
					<Image Source="{StaticResource Brush_Image}" Width="16" Height="16"/>
				</ToggleButton>
                <Popup x:Name="SubMenuPopupBrush" IsOpen="{Binding IsChecked, ElementName=BrushToggle, Mode=TwoWay}"
                       PlacementTarget="{Binding ElementName=BrushToggle}" Placement="Bottom" AllowsTransparency="True" PopupAnimation="None" StaysOpen="{Binding IsMouseOver, ElementName=BrushToggle}">
                    <Border Name="SubmenuBorderBrush" ToolTip="画刷" Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" Margin="5,0" Padding="2">
                        <StackPanel>
                            <MenuItem Header="圆形笔" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Round">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Brush_Normal_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="方形笔" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Square">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Brush_Rect_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="毛刷" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Brush">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Brush_Normal_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="喷枪" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Spray">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Paint_Spray_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator Style="{StaticResource MenuSeparator}"/>
                            <MenuItem Header="蜡笔" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Crayon">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Crayon_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="水彩画笔" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Watercolor">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Watercolor_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="荧光笔" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Highlighter">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Highlighter_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="马赛克" Style="{StaticResource SubMenuItemStyle}" Click="OnBrushStyleClick_Forward" Tag="Mosaic">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Mosaic_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </StackPanel>
                    </Border>
                </Popup>
            </Grid>

            <!-- 形状菜单 -->
            <Grid Margin="0,0,0,0">
				<ToggleButton x:Name="ShapeToggle" x:FieldModifier="public" Style="{StaticResource DropDownButtonStyle}">
					<Image x:Name="CurrentShapeIcon" x:FieldModifier="public" Source="{StaticResource Shapes_Image}" Width="16" Height="16"/>
				</ToggleButton>
                <Popup x:Name="SubMenuPopupShape" IsOpen="{Binding IsChecked, ElementName=ShapeToggle, Mode=TwoWay}"
                       PlacementTarget="{Binding ElementName=ShapeToggle}" Placement="Bottom" AllowsTransparency="True" PopupAnimation="None" 
                       StaysOpen="{Binding IsMouseOver, ElementName=ShapeToggle}">
                    <Border Name="SubmenuBorderShape" ToolTip="形状" Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" Margin="5,0" Padding="2">
                        <StackPanel>
                            <MenuItem Header="矩形" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="Rectangle">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Icon_Shape_Rectangle}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="圆角矩形" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="RoundedRectangle">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Icon_Shape_RoundedRect}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="圆形" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="Ellipse">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Icon_Shape_Ellipse}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="直线" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="Line">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Icon_Shape_Line}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="箭头" Style="{StaticResource SubMenuItemStyle}" Click="OnShapeStyleClick_Forward" Tag="Arrow">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Icon_Shape_Arrow}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </StackPanel>
                    </Border>
                </Popup>
            </Grid>

            <Border DockPanel.Dock="Left" Width="1" Background="#CCC" Margin="2,4"/>

			<Button Margin="2,0" Name="CutImage" x:FieldModifier="public" ToolTip="裁剪选区" Click="CropMenuItem_Click_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image x:Name="CutImageIcon" x:FieldModifier="public" Source="{StaticResource Cut_Selection_Image}" Width="16" Height="16"/>
			</Button>
			<Button Margin="2,0" Name="RotateLeft" x:FieldModifier="public" ToolTip="向左旋转90°" Click="OnRotateLeftClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image Source="{StaticResource Rotate_Left_Image}" Width="16" Height="16"/>
			</Button>
			<Button Margin="2,0" Name="RotateRight" x:FieldModifier="public" ToolTip="向右旋转90°" Click="OnRotateRightClick_Forward" Style="{StaticResource RoundedMenuButtonStyle}">
				<Image Source="{StaticResource Rotate_Right_Image}" Width="16" Height="16"/>
			</Button>


			<!-- 旋转/翻转菜单 -->
            <Grid>
				<ToggleButton x:Name="RotateFlipMenuToggle" x:FieldModifier="public" Style="{StaticResource DropDownButtonStyle}">
					<Image Source="{StaticResource Spin180_Image}" Width="16" Height="16"/>
				</ToggleButton>
                <Popup x:Name="SubMenuPopup" IsOpen="{Binding IsChecked, ElementName=RotateFlipMenuToggle, Mode=TwoWay}"
                       PlacementTarget="{Binding ElementName=RotateFlipMenuToggle}" Placement="Bottom" AllowsTransparency="True" PopupAnimation="None" StaysOpen="{Binding IsMouseOver, ElementName=RotateFlipMenuToggle}">
                    <Border Name="SubmenuBorder" Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" Margin="5,0" ToolTip="旋转/翻转" Padding="2">
                        <StackPanel>
                            <MenuItem Header="旋转180°" Style="{StaticResource SubMenuItemStyle}" Click="OnRotate180Click_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Spin180_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator Style="{StaticResource MenuSeparator}"/>
                            <MenuItem Header="垂直翻转" Style="{StaticResource SubMenuItemStyle}" Click="OnFlipVerticalClick_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Flip_Vertical_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="水平翻转" Style="{StaticResource SubMenuItemStyle}" Click="OnFlipHorizontalClick_Forward">
                                <MenuItem.Icon>
                                    <Image Source="{StaticResource Flip_Horizontal_Image}" Width="16" Height="16"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </StackPanel>
                    </Border>
                </Popup>
            </Grid>

			<Border DockPanel.Dock="Left" Width="1" Background="#CCC" Margin="2,4"/>

			<!-- 颜色区域 -->
            <Button ToolTip="自定义颜色" Click="OnCustomColorClick_Forward" Margin="5,2,5,0" Padding="0" Style="{StaticResource RoundedMenuButtonStyle}" HorizontalAlignment="Left" VerticalAlignment="Top" HorizontalContentAlignment="Left">
                <Image Source="pack://application:,,,/Resources/colorwheel_64x64.png" Width="28" Height="28"/>
            </Button>

			<Button x:Name="ColorBtn1" x:FieldModifier="public" Width="30" Height="30" Margin="2" ToolTip="颜色1" Click="OnColorOneClick_Forward" Tag="True" Style="{StaticResource ColorCircleButtonStyle}" Background="{Binding ForegroundBrush, Mode=TwoWay}"/>
			<Button x:Name="ColorBtn2" x:FieldModifier="public" Width="30" Height="30" Margin="2,0,10,0" ToolTip="颜色2" Click="OnColorTwoClick_Forward" Style="{StaticResource ColorCircleButtonStyle}" Background="{Binding BackgroundBrush, Mode=TwoWay}"/>

			<ItemsControl ItemsSource="{Binding ColorItems}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button Width="20" Height="20" Margin="1" Click="OnColorButtonClick_Forward" Background="{Binding}">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Ellipse x:Name="circle" Fill="{TemplateBinding Background}" Stroke="Transparent" StrokeThickness="1"/>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="circle" Property="Stroke" Value="Gray"/>
                                        </Trigger>
                                        <Trigger Property="IsPressed" Value="True">
                                            <Setter TargetName="circle" Property="Stroke" Value="DarkGray"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </DockPanel>
    </Border>
</UserControl>
